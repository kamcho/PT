{% extends base_html %}
{% load custom_filters %}
{% load static %}
{% block content %}

<!-- Add Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --primary-color: #2563EB;  /* Blue */
        --secondary-color: #10B981;  /* Green */
        --dark-bg: #111827;  /* Dark background */
        --darker-bg: #0F172A;  /* Darker background */
        --card-bg: #1F2937;  /* Card background */
        --text-primary: #F9FAFB;  /* Primary text */
        --text-secondary: #9CA3AF;  /* Secondary text */
        --accent-color: #3B82F6;  /* Accent blue */
        --success-color: #059669;  /* Success green */
        --warning-color: #D97706;  /* Warning orange */
        --danger-color: #DC2626;  /* Danger red */
    }

    body {
        background-color: var(--dark-bg);
    }

    .main-fr {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 1.5rem;
        background: var(--bg-card);
        border-radius: 15px;
        box-shadow: var(--card-shadow);
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    /* Remove styling from a tags */
    a {
        text-decoration: none;
        color: inherit;
    }
    
    /* Style for fee balance and discipline score buttons */
    .status-button {
        border-radius: 30px;
        min-height: 100px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: var(--card-bg);
        color: var(--text-primary);
    }
    
    .status-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--primary-color);
    }
    
    .fee-positive {
        background-color: var(--danger-color);
        color: var(--text-primary);
    }
    
    .fee-negative {
        background-color: var(--success-color);
        color: var(--text-primary);
    }
    
    .discipline-score {
        background-color: var(--card-bg);
        color: var(--text-primary);
    }

    .chart-container {
        position: relative;
        height: 200px;
        width: 100%;
    }
    
    .subject-chart-card {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        color: var(--text-primary);
        transition: transform 0.3s ease;
    }
    
    .subject-chart-card:hover {
        transform: translateY(-5px);
    }

    .guardian-card {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 30px;
        transition: all 0.3s ease;
        margin: 30px auto;
        width: 95%;
        max-width: 1200px;
    }

    .guardian-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .guardian-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .guardian-header i {
        font-size: 1.5rem;
        color: var(--primary-color);
    }

    .guardian-header h5 {
        color: var(--text-primary);
        margin: 0;
    }

    .guardian-list {
        display: grid;
        gap: 1rem;
    }

    .guardian-item {
        background-color: var(--darker-bg);
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }

    .guardian-item:hover {
        transform: translateX(5px);
        border: 1px solid var(--primary-color);
    }

    .guardian-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-primary);
        font-size: 1.25rem;
    }

    .guardian-info {
        flex: 1;
    }

    .guardian-info h6 {
        color: var(--text-primary);
        margin: 0 0 0.25rem 0;
    }

    .guardian-info small {
        color: var(--text-secondary);
        display: block;
    }

    .guardian-contact {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .guardian-contact a {
        color: var(--primary-color);
        font-size: 1rem;
        transition: color 0.3s ease;
    }

    .guardian-contact a:hover {
        color: var(--accent-color);
    }

    @media screen and (max-width: 768px) {
        .main-fr {
            padding: 1rem;
            gap: 1rem;
        }

        .main-fr > div {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        .main-fr table {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .main-fr .table-responsive {
            margin: 0;
            padding: 0;
        }
    }

    @media screen and (max-width: 480px) {
        .main-fr {
            padding: 0.75rem;
            gap: 0.75rem;
        }

        .main-fr h4 {
            font-size: 1.1rem;
        }

        .main-fr .table th,
        .main-fr .table td {
            padding: 0.5rem;
            font-size: 0.875rem;
        }
    }

    .main-fr h4 {
        color: var(--accent-color);
    }

    .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 1rem;
        flex-wrap: wrap;
    }

    .action-btn {
        background-color: var(--primary-color);
        color: var(--text-primary);
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 15px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .action-btn i {
        font-size: 1.1rem;
    }

    @media screen and (max-width: 768px) {
        .action-buttons {
            justify-content: center;
            padding: 1rem;
        }

        .action-btn {
            width: 100%;
            justify-content: center;
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
        }
    }

    @media screen and (max-width: 480px) {
        .action-buttons {
            gap: 0.75rem;
        }

        .action-btn {
            font-size: 0.85rem;
            padding: 0.6rem 0.75rem;
        }
    }
</style>

<div style="background-color:var(--card-bg); margin-top: -9px;"><br><br>
    {% if user.role == 'Guardian' %}
    <div class="action-buttons">
        <a href="{% url 'learn' student.adm_no student.academicprofile.current_class.grade %}">
            <button class="action-btn"><i class="bi bi-stars"></i>Online Exams</button>
        </a>
        <a href="{% url 'ask-ai' student.adm_no %}">
            <button class="action-btn"><i class="bi bi-robot"></i>AI Assistant</button>
        </a>
        {% if student.academicprofile.current_class %}
            {% with class_tests=student.academicprofile.current_class.classtest_set.all %}
                {% if class_tests %}
                    <a href="{% url 'assignments' student.adm_no %}">
                        <button class="action-btn"><i class="bi bi-journal-text"></i>Assignments</button>
                    </a>
                {% endif %}
            {% endwith %}
        {% endif %}
    </div>
    {% endif %}
<div class="main-fr">
    <div style="background-color: var(--card-bg);border-radius: 10px;float: left;padding: 40px;">
        <h5 style="color: var(--text-primary);">Personal Info</h5><br><br>
        <div style="display: grid;grid-template-columns: 40% 60%;">
            <img style="width: 100px; height: 100px;border-radius: 5%;" src="{% static 'Users/child.jpg' %}">
        <div><h6 style="color: var(--text-primary);">{{ student.studentprofile.get_names|title }}</h6>
            <h6 style="color: var(--text-secondary);">{{ student.adm_no }}</h6>
            <h6 style="color: var(--text-secondary);">{{ student.studentprofile.gender }}</h6>
            <h6 style="color: var(--primary-color);">{{ student.school }}</h6>
            <h6 style="color: var(--text-secondary);">Grade {{ student.academicprofile.current_class.grade|title }}  {{ student.academicprofile.current_class|title }}</h6></div>
            
        </div><br><br>
        <div style="background-color: var(--darker-bg);border-radius: 20px;align-items: center;align-items: center;padding: 20px;">
            <div style="display: flex;margin: 0 auto;gap: 20px;width: 99%;">
                {% for day in days %}
    {% with student|get_attendance:day.date as attendance %}
    {% if attendance == 'PRESENT' %}
    <div style="background-color: var(--success-color); border-radius: 30%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: var(--text-primary);">
        {{ day.day }}
    </div>
{% elif attendance == 'ABSENT' %}
    <div style="background-color: var(--danger-color); border-radius: 30%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: var(--text-primary);">
        {{ day.day }}
    </div>
{% elif attendance == 'N/A' %}
    <div style="background-color: var(--text-secondary); border-radius: 30%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: var(--text-primary);">
        {{ day.day }}
    </div>
{% endif %}

    {% endwith %}
{% endfor %}

            </div>
        </div>
    </div>
    <div style="background-color: var(--card-bg);border-radius: 10px;padding: 30px;">
        <h5 style="color: var(--text-primary);">My Subjects</h5>
        <br><br><h6 style="color: var(--text-primary);">Selected Subjects</h6>
        <div style="display: flex;flex-wrap: wrap;gap: 10px;">
        {% if mysubjects %}
        {% for subject in mysubjects %}
            <div style="background-color: var(--darker-bg);color: var(--text-primary);padding: 5px;border-radius: 5px;">
                <small><i class="bi bi-check"></i>{{ subject }}</small>
            </div>
            {% endfor %}
        {% else %}
            <a href="{% url 'student-subject-select' student.adm_no %}"><h6 class="text-center" style="color: var(--danger-color);justify-content: center;"><i class="bi bi-info">You have not selected any subjects! </i></h6></a>
        {% endif %}
        </div><br><hr style="border-color: rgba(255, 255, 255, 0.1);">
        <br><br>
        {% if mysubjects %}
        <h6 style="color: var(--danger-color);">ForeGone</h6>
        <div style="display: flex;flex-wrap: wrap;gap: 10px;">
        {% for subject in foregone %}
            <div style="background-color: var(--darker-bg);color: var(--text-secondary);padding: 5px;border-radius: 5px;">
                <small><i class="bi bi-x"></i>{{ subject }}</small>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <h6 style="color: var(--text-primary);">Available Subjects</h6>
        <div style="display: flex;flex-wrap: wrap;gap: 10px;">
        {% for subject in foregone %}
            <div style="background-color: var(--darker-bg);color: var(--text-secondary);padding: 5px;border-radius: 5px;">
                <small><i class="bi bi-x"></i>{{ subject }}</small>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    <div style="background-color: var(--card-bg); border-radius: 10px; padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center;">
        <h5 style="color: var(--text-primary);">Fees & Discipline</h5>
        <h6 style="color: var(--text-primary);">{{ student.studentprofile.get_names|title }}</h6>
        <br><br>
        <a href="{% url 'student-fee-profile' student.adm_no %}">
            <div class="status-button {% if student.studentsfeeaccount.balance < 0 %}fee-positive{% else %}fee-negative{% endif %}">
                <h5>{% if student.studentsfeeaccount.balance < 0 %}Fee Balance - {{ student.studentsfeeaccount.balance|title }}{% else %}Fee Overpayment - {{ student.studentsfeeaccount.balance|title }}{% endif %}</h5>
            </div>
        </a><br><br>
        <a href="{% url 'students-discipline' student.adm_no %}">
            <div class="status-button discipline-score">
                <h5>Discipline - {{ student.studentdisciplinescore.points|title }} | <strong style="font-weight: bolder;color: var(--primary-color);">100</strong></h5>
            </div>
        </a>
    </div>
</div>
<br><br>
</div>

<div class="guardian-card">
    <div class="guardian-header">
        <i class="bi bi-people-fill"></i>
        <h5>Linked Guardians</h5>
    </div>
    <div class="guardian-list">
        {% for pf in guardians %}
            <div class="guardian-item">
                <div class="guardian-avatar">
                    <i class="bi bi-person"></i>
                </div>
                <div class="guardian-info">
                    <h6>{{ pf.user.personalprofile.get_names|title }}</h6>
                    <small>{{ pf.user.personalprofile.gender }}</small>
                    <small>{{pf.user.personalprofile.phone }}</small>
                    <small>{{pf.user.personalprofile.phone2 }}</small>
                    <small>{{pf.user.personalprofile.location }}</small>
                    <div class="guardian-contact">
                        {% if kid.guardian.personalprofile.phone %}
                            <a href="tel:{{ kid.guardian.personalprofile.phone }}" title="Call">
                                <i class="bi bi-telephone"></i>
                            </a>
                        {% endif %}
                        {% if kid.guardian.email %}
                            <a href="mailto:{{ kid.guardian.email }}" title="Email">
                                <i class="bi bi-envelope"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="guardian-item" style="justify-content: center;">
                <h6 style="color: var(--text-secondary); margin: 0;">No guardians linked to this student</h6>
            </div>
        {% endfor %}
    </div>
</div>

<div style="width: 95%;margin: 60px auto;position: relative;">
    <h6 style="padding: 20px;color: var(--text-primary);" class="text-center">Performance <strong style="color: var(--primary-color);">Analytics</strong></h6>
    <form method="post" style="display: flex; justify-content: center; margin-bottom: 20px;">{% csrf_token %}
        <div class="input-group" style="max-width: 600px;">
            <select class="form-select" aria-label="Default select example" name="grade" required>
                <option value="" selected>Select Grade</option>
                {% for grade in grades %}
                    <option value="{{grade}}">Grade {{ grade }}</option>
                {% endfor %}
            </select>
            <select class="form-select" aria-label="Default select example" name="term" required>
                <option value="" selected>Select Term</option>
                <option value="Term 1">Term 1</option>
                <option value="Term 2">Term 2</option>
                <option value="Term 3">Term 3</option>
            </select>
            <button class="btn" style="background-color: var(--primary-color); color: var(--text-primary);">Filter</button>
        </div>
    </form>

    <div id="def" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%; margin: 0 auto; justify-content: center;">
        {% for subject in student.mysubjects.name.all %}
        <a href="{% url 'students-exam-profile' student.adm_no %}" class="text-decoration-none">
            <div class="subject-chart-card">
                <h6 class="text-center mb-3">{{ subject.name }}</h6>
                <div class="chart-container">
                    <canvas id="chart-{{ forloop.counter }}"></canvas>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
</div>

<script>
// Wait for DOM to be fully loaded
document.addEventListener("DOMContentLoaded", function() {
    {% for subject in student.mysubjects.name.all %}
        var openerScore = {% get_subject_score student.adm_no grade subject.id term 'OPENER' %};
        var midtermScore = {% get_subject_score student.adm_no grade subject.id term 'MID' %};
        var endtermScore = {% get_subject_score student.adm_no grade subject.id term 'END' %};
        
        var ctx = document.getElementById("chart-{{ forloop.counter }}");
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Opener', 'Mid-Term', 'End-Term'],
                    datasets: [{
                        label: '{{ subject.name }} Scores',
                        data: [
                            openerScore || 0,
                            midtermScore || 0,
                            endtermScore || 0
                        ],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.5)',  // Primary color
                            'rgba(79, 70, 229, 0.5)',   // Secondary color
                            'rgba(129, 140, 248, 0.5)'  // Accent color
                        ],
                        borderColor: [
                            'rgba(99, 102, 241, 1)',
                            'rgba(79, 70, 229, 1)',
                            'rgba(129, 140, 248, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(248, 250, 252, 0.8)',
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'rgba(248, 250, 252, 0.8)',
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleFont: {
                                family: "'Inter', sans-serif",
                                size: 14
                            },
                            bodyFont: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            padding: 12,
                            cornerRadius: 8
                        }
                    }
                }
            });
        }
    {% endfor %}
});
</script>

<div style="width: 99%;margin: 150px auto 0 auto;background-color: var(--card-bg);color: var(--text-primary);position: relative;"><br><br>
    <h5 style="padding-left: 30px;" class="text-center">E-Learning, Assignments & Analytics</h5><br><br>
    
    <div style="gap: 10px; width: 100%; margin: 0 auto; justify-content: center;position: relative;">
        <div style="padding: 30px;background-color: var(--darker-bg);color: var(--text-primary);width: 90%;max-width: 800px;margin: 0 auto;position: relative;">
            <a class="btn" style="position: absolute;top: 10px;right: 30px;background-color: var(--card-bg);color: var(--text-primary);" href="{% url 'task-view-select' student.adm_no student.academicprofile.current_class.grade %}">View All</a>
            <h6>E-Learning Progress</h6>
            <select class="form-select" aria-label="Default select example">
                <option value="" selected>Select Grade</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select><br><br>
            {% for subject in student.mysubjects.name.all %}
            <h6>{{ subject.name }}</h6>
            
            <div class="progress" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar" {% with student|subject_progress:subject.id as progressive  %}
                {% if progressive < 50 %}
                  style="width: {{ progressive }}%;background-color:var(--danger-color)"
                {% else %}
                  style="width: {{ progressive }}%;background-color: var(--primary-color);color:var(--text-primary);"
                {% endif %}
                  aria-valuenow="63" aria-valuemin="0" aria-valuemax="100">
                  {{ progressive }}%
              {% endwith %}</div>
            </div><br>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}
{% extends 'Users/base.html' %}
{% load custom_filters %}
{% block content %}
<div  style="background: linear-gradient(109.6deg, rgb(36, 45, 57) 11.2%, rgb(16, 37, 60) 51.2%, rgb(0, 0, 0) 98.6%) !important;height: 80vh;margin-top: 60px;">
    <br><br>
    <div class="container chat">
        
        <div id="list-group" class="list-group w-auto">
            <div href="#" class="ai">
              <h6><i class="bi bi-robot"></i> Robo AI</h6>
              <div class="d-flex gap-2 w-100 justify-content-between">
                <div>
                  <p class="mb-0 opacity-75">Hi, my name is RoboAI - your learning assistant, how can I help you today ?</p>
                </div>
              </div>
            </div>


            {% for chat in chats %}
                {% if chat.type == 'completion' %}
                    <div href="#" class="ai">
                        <h6><i class="bi bi-robot"></i> Robo AI</h6>
                        <div class="d-flex gap-2 w-100 justify-content-between">
                        <div>
                            <p class="mb-0 opacity-75">{{ chat.content }}</p>
                        </div>
                        </div>
                    </div>
                {% else %}
                    <div href="#" class="you">
                        <h6><i class="bi bi-robot"></i> you</h6>
                        <div class="d-flex gap-2 w-100 justify-content-between">
                        <div>
                            <p class="mb-0 opacity-75">{{ chat.content }}</p>
                        </div>
                        </div>
                    </div>
                {% endif %}



            {% endfor %}
        </div>
          
        <div class="text-center bottom-bar">
            <div class="input-group mb-3">
            {% if user.mysubscription.status %}
                {% if user.ratelimiter.tokens %}
                    <input type="text" class="form-control" style="height: 60px;border-radius: 10px;padding-left: 40px;" placeholder="Message AI Assistant" id="chat-input" required>
                    <input type="file" id="image-input" accept="image/*" class="form-control" style="display: none;">
                    <button type="button" id="gpt-button" class="btn btn-primary" style="border-radius: 10px;">Ask AI</button>
                {% else %}
                    <input type="text" class="form-control" placeholder="You have finished your allocated tokens. Contact support for assistance!" id="chat-input" disabled>
                    <button type="button" id="gpt-button" class="btn btn-primary" style="border-radius: 10px;" disabled>Ask AI</button>
                {% endif %}
            {% else %}
                    <input type="text" class="form-control" placeholder="Subscribe to speak to ROBOAI" id="chat-input" disabled>
                    <button type="button" id="gpt-button" class="btn btn-primary" style="border-radius: 10px;" disabled>Ask AI</button>
            {% endif %}
                
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Upload image button click event
        $("#upload-image-button").click(function() {
            $("#image-input").click(); // Trigger file input click
        });

        // Handle image input change event
        $("#image-input").change(function() {
            var file = $(this)[0].files[0];
            var reader = new FileReader();

            reader.onloadend = function() {
                var base64_image = reader.result.split(',')[1]; // Extract base64 data

                // Display preview or handle the image data as needed
                console.log(base64_image); // Example: Log base64 image data
            };

            if (file) {
                reader.readAsDataURL(file); // Read file as data URL
            }
        });

        // Ask AI button click event
        $("#gpt-button").click(function() {
            var question = $("#chat-input").val();
            var base64_image = $("#image-input").val(); // Replace with actual base64 image data

            // Display user's question in the chat interface
            let html_user_question = `
                <div class='you' style='padding:30px;'>
                    <div href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3">
                        <i class='bi bi-person'></i>
                        <div class="d-flex gap-2 w-100 justify-content-between">
                            <div>
                                <p class="mb-0 opacity-75">${question}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $("#list-group").append(html_user_question);

            // AJAX CALL TO SERVER
            $.ajax({
                type: "POST",
                url: "{% url 'answer' %}",
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'prompt': question,
                    'image_base64': base64_image
                },
                success: function(data) {
                    // Display AI's response in the chat interface
                    let html_ai_response = `
                        <div href="#" class="ai" >
                            <h6><i class='bi bi-robot'></i> Robo AI</h6>
                            <div class="d-flex gap-2 w-100 justify-content-between">
                                <div>
                                    <p class="mb-0 opacity-75">${data.answer}</p>
                                </div>
                            </div>
                            <br><br>
                            <h6 class='play'><i class='bi bi-play-circle'></i></h6>
                        </div>
                        <div style="margin-bottom:80px;">
                        </div>
                    `;
                    $("#list-group").append(html_ai_response);

                    // Scroll to bottom
                    $('html, body').animate({
                        scrollTop: $(document).height()
                    }, 'slow');
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });

            // Clear input field after submitting
            $("#chat-input").val('');
        });
    });
</script>

{% endblock %}
